matrix:
  allow_failures:
    - env: JOB=fastlane_deploy
    
  include:
    - name: 'Flutter test and apk build' 
      dist: trusty
      language: android
      jdk: oraclejdk8 # Android sdkmanager doesn't support jdk 9+
      licenses:
        - android-sdk-preview-license-.+
        - android-sdk-license-.+
        - google-gdk-license-.+
      android:
        components:
          - build-tools-28.0.3
          - android-28
      before_script:
        - openssl aes-256-cbc -K $encrypted_2db283701f8c_key -iv $encrypted_2db283701f8c_iv 
          -in secrets.tar.enc -out secrets.tar -d
        - tar xvf secrets.tar
        - if [  ! -d "flutter" ] ; then git clone https://github.com/flutter/flutter.git -b dev; fi;
        - export PATH=./flutter/bin:$PATH
        - flutter upgrade
      script:
        - flutter pub get
        - flutter test 
        - flutter build apk --target-platform android-arm64 --verbose # we only need to see if an apk builds correctly so the quicker the better

    - name: 'Fastlane Deploy'
      language: android
      dist: trusty
      jdk: oraclejdk8
      env: JOB=fastlane_deploy
      licenses: 
        - android-sdk-license-.+
        - android-sdk-preview-license-.+
        - google-gdk-license-.+
      android:
        components: 
          - build-tools-28.0.3
          - android-28
      before_install: 
        - bundle install --gemfile=android/Gemfile
      before_script:
        - openssl aes-256-cbc -K $encrypted_2db283701f8c_key -iv $encrypted_2db283701f8c_iv 
          -in secrets.tar.enc -out secrets.tar -d
        - tar xvf secrets.tar
        - if [  ! -d "flutter" ] ; then git clone https://github.com/flutter/flutter.git -b dev; fi;
        - export PATH=./flutter/bin:$PATH
        - flutter upgrade 
      script:
        - flutter pub get
        - flutter build appbundle # release is the default mode for build
        - cd android && bundle exec fastlane beta               

cache:
  bundler: true
  directories:
    - "$HOME/.pub-cache"
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
    - "$HOME/.android/build-cache"
    - "$HOME/flutter"

