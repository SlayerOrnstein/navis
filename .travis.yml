matrix:
  fast_finish: true
  allow_failures:
    - env: JOB=APK
    - env: JOB=IPA
  include:
    - env: JOB=TEST
      language: android
      jdk: openjdk8
      os: linux
      dist: xenial
      android:
        components:
          - build-tools-28.0.3
          - android-28
          - android-29
        licenses:
          - android-sdk-preview-license-.+
          - android-sdk-license-.+
          - google-gdk-license-.+
      before_script:
        - if [  ! -d "flutter" ] ; then git clone https://github.com/flutter/flutter.git -b
          1.17.0; fi;
        - export PATH=./flutter/bin:$PATH
      script:
        - flutter pub get
        - flutter test

    - env: JOB=APK
      language: android
      jdk: openjdk8
      os: linux
      dist: xenial
      android:
        components:
          - build-tools-28.0.3
          - android-28
          - android-29
        licenses:
          - android-sdk-preview-license-.+
          - android-sdk-license-.+
          - google-gdk-license-.+
      before_install:
        - openssl aes-256-cbc -K $encrypted_3b9f0b9d36d1_key -iv $encrypted_3b9f0b9d36d1_iv
          -in secrets.tar.enc -out secrets.tar -d
      before_script:
        - tar xvf secrets.tar
        - if [  ! -d "flutter" ] ; then git clone https://github.com/flutter/flutter.git -b
          1.17.0; fi;
        - export PATH=./flutter/bin:$PATH
      script:
        - flutter pub get
        - mkdir lib/generated/intl && flutter pub run intl_translation:generate_from_arb --output-dir=lib/generated/intl
          --no-use-deferred-loading lib/generated/l10n.dart lib/l10n/intl_*.arb
        - flutter build apk --target-platform android-arm

    - env: JOB=IPA
      os: osx
      osx_image: xcode11.4
      language: generic
      before_install:
        - openssl aes-256-cbc -K $encrypted_3b9f0b9d36d1_key -iv $encrypted_3b9f0b9d36d1_iv
          -in secrets.tar.enc -out secrets.tar -d
      before_script:
        - pip install six
        - brew update
        - brew install
        - brew install --HEAD libimobiledevice
        - brew install ideviceinstaller
        - brew install ios-deploy
        - tar xvf secrets.tar
        - if [  ! -d "flutter" ] ; then git clone https://github.com/flutter/flutter.git -b
          1.17.0; fi;
        - export PATH=./flutter/bin:$PATH
      script:
        - flutter pub get
        - mkdir lib/generated/intl && flutter pub run intl_translation:generate_from_arb --output-dir=lib/generated/intl
          --no-use-deferred-loading lib/generated/l10n.dart lib/l10n/intl_*.arb
        - flutter build ios --no-codesign

cache:
  directories:
    - $HOME/.pub-cache
