name: Deploy
on:
  release:
    types: [published, created]
jobs:
  android-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: "12.x"
      - uses: subosito/flutter-action@v1
        with:
          channel: stable
      - name: Decode signing key and services json
        run: base64 -d <<< $TENNO_STORE > android/keystore.jks
        run: base64 -d <<< $TENNO_FIREBASE > android/app/google-services.json
        run: base64 -d <<< $NAVIS_SERVICE_ACCOUNT > android/app/fastlane.json
      - name: Build App bundle  
        run: flutter pub get
        run: flutter build appbundle
      - name: Google Play Store Deploy
        uses: maierj/fastlane-action@v1
        with:
          lane: beta
          subdirectory: android
      - name: Clean build directory
        run: flutter clean
      - name: Build split apks per abi
        run: flutter build apk --split-per-abi
      - name: Github Releases Deploy
        uses: xresloader/upload-to-github-release@v1
        env:
            GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
            file: "build/app/outputs/apk/release/*.apk"
            tags: true      
